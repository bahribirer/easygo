// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Varsayılan: her şeye erişimi kapat
    match /{document=**} {
      allow read, write: if false;
    }

    // Kullanıcı alanı
    match /users/{userId} {

      // Kullanıcı dokümanını sadece sahibi okuyabilsin
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // kullanıcı dokümanını istemciden yazdırmıyorsan kapalı tut

      // Profili görüntüleyenler alt koleksiyonu
      match /profileViews/{viewerId} {
        // Sadece profil sahibi okuyabilir
        allow read: if request.auth != null && request.auth.uid == userId;

        // Yazma:
        // - görüntüleyen kişi kendi kaydını yazabilir (viewerId == auth.uid)
        // - profil sahibi de yazabilir (ör. admin veya sıfırlama işlemi için)
        allow create, update: if request.auth != null
                              && (request.auth.uid == viewerId || request.auth.uid == userId);

        // Silme istersen yalnızca sahibi silebilsin
        allow delete: if request.auth != null && request.auth.uid == userId;
      }

      // Toplam sayaç / agregalar
      match /aggregates/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
